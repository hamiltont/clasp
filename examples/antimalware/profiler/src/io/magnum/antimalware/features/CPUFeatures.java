package io.magnum.antimalware.features;

import java.io.BufferedReader;
import java.io.IOException;
import java.io.InputStreamReader;
import java.util.ArrayList;

/**
 * Gets CPU features by parsing top's output
 */
public class CPUFeatures extends AbstractFeatures {	
  public CPUFeatures() {
    _tags = new String[] { "cpuUser", "cpuSystem", "cpuIdle", "cpuOther" };
  }

  public FeatureValue[] getFeatureVector() {
    String topOut = executeTop();
    int[] cpuUsage = extractTokens(topOut);

    int cpuUser = cpuUsage[0];
    int cpuSystem = cpuUsage[1];
    int cpuIdle = cpuUsage[2];
    int cpuOther = cpuUsage[3];

    return new FeatureValue[] { new FeatureValue(cpuUser),
      new FeatureValue(cpuSystem), new FeatureValue(cpuIdle),
      new FeatureValue(cpuOther) };
  }

  private String executeTop() {
    // http://stackoverflow.com/questions/2467579
    java.lang.Process p = null;
    BufferedReader in = null;
    String topOut = "";
    try {
      p = Runtime.getRuntime().exec("top -n 1");
      in = new BufferedReader(new InputStreamReader(p.getInputStream()));
      while (topOut == null || topOut.contentEquals("")) {
        topOut = in.readLine();
      }
    } catch (IOException e) {
      // TODO.
    } finally {
      try {
        in.close();
        p.destroy();
      } catch (IOException e) { }
    }
    topOut = topOut.replaceAll(",", "");
    topOut = topOut.replaceAll("User", "");
    topOut = topOut.replaceAll("System", "");
    topOut = topOut.replaceAll("IOW", "");
    topOut = topOut.replaceAll("IRQ", "");
    topOut = topOut.replaceAll("%", "");
    for (int i = 0; i < 10; i++) {
      topOut = topOut.replaceAll("  ", " ");
    }
    topOut = topOut.trim();
    return topOut;
  }

  private int[] extractTokens(String str) {
    int[] cpuUsage = new int[4];
    String[] topOutToks = str.split(" ");

    for (int i = 0; i < 4; i++) {
      topOutToks[i] = topOutToks[i].trim();
      cpuUsage[i] = Integer.parseInt(topOutToks[i]);
    }
    return cpuUsage;
  }
}
