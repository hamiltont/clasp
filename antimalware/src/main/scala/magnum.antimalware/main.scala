package magnum.antimalware

import java.io.File
import scala.language.reflectiveCalls

object Main {
  def main(args: Array[String]) = {
    import org.rogach.scallop.ScallopConf;
    val opts = new ScallopConf(args) {
      banner("Android Antimalware.\n" +
        "Usage: java -jar antimalware.jar --mode training")
      val mode = opt[String] (
        "mode", descr = "Training/Testing", required = true)
      val wekaOnly = opt[Boolean](
        "wekaonly", descr = "Don't profile and only run Weka's analysis.")
      val numEmu = opt[Int](
        "numemu", descr = "The number of emulators to run. (Unsupported.)")
      val help = opt[Boolean]("help",
        noshort = true, descr = "Show this message.")
    }

    val mode: String = opts.mode.apply
    if (mode != "Training" && mode != "Testing") {
      println("Unrecognized mode.")
      System.exit(42)
    }

    if (!checkDirStruct(mode)) {
      println("Incorrect directory structure.")
      println("Correct structure:\n" +
              "  ./" + mode + "/Benign\n" +
              "  ./" + mode + "/Malicious")
      System.exit(42)
    }

    var antimalware = new File("Profiler.apk")
    if (! antimalware.exists) {
      println("'Profiler.apk' not found. Exiting.")
      System.exit(42)
    }

    if(!opts.wekaOnly.isSupplied || !opts.wekaOnly.apply) {
      var numEmu = 1;
      if (opts.numEmu.isSupplied) numEmu = opts.numEmu.apply
      Partitioner.partition(mode, numEmu)
      Profiler.run(mode)
      Partitioner.unpartition(mode)
    }
    WekaWrapper.run(mode)
  }

  private def checkDirStruct(mode: String): Boolean = {
    var subDirs = getSubDirs(".")
    if (!getSubDirs(".").contains(mode)) {
      return false
    }

    var modeSubDirs = getSubDirs(mode)
    if (!modeSubDirs.contains("Benign") ||
        !modeSubDirs.contains("Malicious")) {
      return false
    }
    return true
  }

  private def getSubDirs(dirName: String): Array[String] = {
    var file: File = new File(dirName)
    if (file.listFiles == null) {
      return Array[String]()
    }
    return file.listFiles.filter(_.isDirectory).map(_.getName)
  }
}
