package magnum.antimalware

import java.io.File

object Profiler {
  import core._
  import core.sdktools.sdk._
  import core.sdktools.EmulatorOptions
  import scala.actors._ // For Thread.sleep. TODO remove!

  var emuOpts = new EmulatorOptions
  emuOpts.noBootAnim = true
  //emuOpts.noWindow = true
  emuOpts.noSnapShotLoad = true

  def run(mode: String) {
    println("Collecting.")
    collectEmu(mode, "Benign")
    // TODO: Uncomment.
    //collectEmu(mode, "Malicious")
  }

  def collectEmu(mode: String, classification: String) {
    var file: File = new File(s"$mode/$classification")
    var apkList = file.listFiles
    
    val node = new Node
    val emulator = node.run_emulator(emuOpts)

    // TODO: Block until ready.
    Thread.sleep(60000)
    
    for (apk <- apkList) {
      startProfiler(emulator, classification)
      //emulator.installApk("foo")

      // TODO
      //package=`aapt dump badging $1 | 
      //  grep -o "package: name='[^']*'" |
      //  cut -f2 -d \'`
      val packageName = "to.do"

      println("Monkey testing application '" + packageName + "'.")
      //emulator.remoteShell(s"monkey -p $packageName" +
      //  "--pct-syskeys 0 --pct-anyevent 0 -s 0 10000") //TODO seed

      stopProfiler(emulator, packageName)
    }
  }

  def startProfiler(emulator: Emulator, classification: String) {
    println("Installing 'Profiler.apk'.")
    // TODO: Device not found errors, though the same commands
    // work when I call them from my shell?
    //emulator.installApk("Profiler.apk")

    println("Starting MalwareActivity.")
    //emulator.startActivity("org.vt.magnum.antimalware.main/.MalwareActivity")

    Thread.sleep(5000);
    
    println("Setting the classification to '" + classification + "'.")
    //emulator.remoteShell("echo $CLASS > /sdcard/magnum/classification")
  }

  def stopProfiler(emulator: Emulator, packageName: String) {
    println(s"Pulling the arff for '$packageName'")
    emulator.pull("/sdcard/magnum/malware.arff",
                  s"../arff/$packageName.arff")

    println("Stopping profiling activity.")
    //emulator.stopPackage("org.vt.magnum.antimalware.main")

  }
}
